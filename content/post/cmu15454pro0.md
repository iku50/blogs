---
title: "CMU15445-pro0记录"
date: 2023-03-12T16:23:27+08:00
draft: false
description: "CMU 15-445"
author: "[Wizzz]"
tags: ["database","c++"]
categories: "database"
---

## CMU15445-pro0记录

之前的网站现在开始更新了，主要放一些 lab 的记录之类的，这里是CMU的经典数据库课程 CMU15-445 的 lab 记录分析。

Lab是CMU15-445 Spring（2023）

课听的是FALL（2022）的，毕竟是Andy的。

### Project 0 - C++Primer

Project 0 主要是对编程能力的一个小考核。如果没能完成它那实际上是没有达到上这门课的水平的。在这一季的课程里的 Project 0 跟之前有所不同。主体上是利用Modern C++实现一个 Copy-On-Write 字典树。

#### 0：Lab 前准备

由于我用的是 Manjaro 的 Linux 系统，所以不能直接满足它的环境要求（Mac 或 ubuntu），所以这里我用 Docker 安装一个 ubuntu20.04 的容器。并用 vscode 自带的远程开发连接到容器内，再 push 下来一键部署。值得注意的是，这个工程需要用到 Clang 编译，而不是我们常见的 gcc。

#### 1：Task #1 Copy-On-Write Trie

仔细阅读了它网站上的文档内容和相关的代码文件后，发现它在这一阶段考察 Modern C++ 的知识点有以下两个：

1. 模板
2. 智能指针（`std::shared_ptr` 和 `std::unique_ptr`）

其中智能指针是考察的重点。

而就算法而言，三个要求实现的方法：`Get`，`Put`，`Remove`，要求用 Copy-On-Write 的方式实现，在文档的示例中有所演示。其核心思想是，在改写字典树的过程中，任何需要发生变动的节点的实际变动都由其克隆体完成，本身不变。换句话说，通过改写字典树，我们实际上可以得到两棵不一样且功能正常的字典树。原字典树不变，新字典树能用原字典树的节点就用，不能用就新建节点。

Get 方法的实现过程比较简单，除了几个需要特殊处理的情况外，大体的思想是按提供的 `std::string_view` 进行由顶至下的字符匹配需要注意的是返回的结果需要用 `dynamic_cast` 进行转型，因为是由基类 `TrieNode` 转继承类 `TrieNodeWithValue` 。且由于模板的存在，Value 的类型可能会不一样，所以需要动态的类型检查，因此这里必须用 `dynamic_cast` 进行判断。

Put 方法的实现稍显复杂，因为 Copy-on-Write 的特性要求，所以比一般的字典树实现多了要把改变节点的根节点也进行复制替换。所以这里建了一个 `std::vector` 来保存字典树进行搜索时的路径，而一旦搜索结束且叶子节点都完成替换或创建（当 key 对应的叶子节点不存在时就新建立节点），就向上回溯进行替换。

Remove 方法大体上延续 Put 方法的思路，主要是要当节点无值且无子节点时就要删除节点。因此向上回溯的过程里多一个判断是否无值且无子节点就可以了。

最后的测试结果如下：

![测试结果](media/cmu15454/2023-03-12_19-24.png)

#### Task #2 Concurrent Key-Value Store

完成 Copy-on-write  trie 后，要完成并发键值存储。以适应多线程下的操作。一样是那三个方法。实现需要的就是理解多线程下互斥锁的功能。在 C++ 里，互斥锁是 `std::Mutex` ，在头文件里已经帮我们实现了读写锁，要求我们实现写读可同时进行，那么其实要做的就非常容易了。

对于 Get，直接使用上面我们实现的方法，只需在前面加上在加锁解锁间复制根节点指针，并让之后的 Get 操作都对这个复制的指针进行就可以了。

对 Put 方法，因为已经实现了 Copy-on-Write 。所以比一般的字典树相比，写是在新的字典树上写，读可以在旧有的字典树上读，这是读写可以同时进行的关键，在这里它要求我们用它给的写锁实现读写同时进行这一功能。所以大体上，首先保证只有一个写者，所以方法使用时写锁必须全程保持 Lock，而读锁只需要在取出根和放回修改后的新根的时候是 Lock 的就行。保持这个思路去写就没问题。

Remove 方法与 Put 方法的思路一样。

下面是测试内容。

![1678621339132](media/cmu15454/2023-03-12_19-42.png)

#### Task #3 - Debugging

这里没什么好说的，设置断点在 vscode 中直接看就行。

#### Task #4 - SQL String Functions

这一个 Task 放在这里主要是让我们熟悉流程用的，要求实现 `Upper` 方法和 `Lower` 方法。这个是个人都会写。在C++里分别只需要使用 `std` 里自带的 `transform` 函数就可以了。主要是要把方法注册到 SQL 中使其能够使用，一个简单的 `if-else` 结构就能完成。

简单测试一下没什么问题。

![1678623187735](media/cmu15454/2023-03-12_20-12.png)

接着运行它给我们的三个数据库上的测试

基础测试：

![1678623553473](media/cmu15454/2023-03-12_20-16.png)

异常测试：

![1678623664143](media/cmu15454/2023-03-12_20-18.png)

字符串扫描测试：

![1678623876602](media/cmu15454/2023-03-12_20-18_1.png)

全部通过。

### 总结

作为一个入门级别的 Project ，这个项目是确实挺全面的。Modern C++的各项内容都有考察到。对我这个普通大二学生来说算是适中的难度。工程量很小，加起来估计一两百行的代码。写的时间加起来大概是 4 到 5 个小时。总体来说，对于之后的学习，算是个良好的开端吧。
